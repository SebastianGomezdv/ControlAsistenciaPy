<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Registro de Entrada y Salida | GCO Grupo Uribe</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="{{ url_for('asistencia', fecha=fecha) }}">Registro de Asistencia</a>
        <a href="{{ url_for('registros') }}">Registros de Empleados</a>
        <a href="{{ url_for('logout') }}" class="logout">Cerrar SesiÃ³n</a>
    </nav>

    <div class="main-flex">
        <div class="container">
            <h1 class="titulo-gco">GCO</h1>
            <h2>ğŸ“‹ Registro de Entrada y Salida</h2>
            <p>Fecha seleccionada: {{ fecha }}</p>

            <div class="video-container">
                <img id="camara" src="{{ url_for('video_feed') }}" width="640" height="400">
                <!-- Canvas para mostrar la "foto" congelada -->
                <canvas id="canvas-snapshot" width="640" height="400" style="display: none; border-radius: 10px; max-width: 100%;"></canvas>
            </div>

            <button type="button" onclick="registrarAsistencia()">Registrar</button>

            <div id="procesando" class="mensaje-procesando">
                <span>Guardando registro, por favor espere...</span>
            </div>
        </div>
        <div class="guardar-lateral">
            <button onclick="guardarRegistrosDeHoy()">ğŸ’¾ Guardar registro de hoy</button>
        </div>
    </div>

    <script>
        // Forzar ocultar el mensaje de procesando al cargar la pÃ¡gina
        window.addEventListener('DOMContentLoaded', function() {
            var procesando = document.getElementById('procesando');
            if (procesando) procesando.style.display = 'none';
        });

        // -------- Registrar entrada/salida --------
        async function registrarAsistencia() {
            const video = document.getElementById("camara");
            const canvas = document.getElementById("canvas-snapshot");
            const context = canvas.getContext("2d");
            const procesando = document.getElementById("procesando");
            const boton = document.querySelector("button[type='button']");

            // --- LÃ“GICA PARA CONGELAR LA IMAGEN ---
            // 1. Ajustar el tamaÃ±o del canvas al tamaÃ±o visible de la imagen
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;
            // 2. Dibujar la imagen actual del video en el canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            // 3. Ocultar el video en vivo y mostrar el canvas con la foto
            video.style.display = "none";
            canvas.style.display = "block";
            // --- FIN DE LA LÃ“GICA DE CONGELACIÃ“N ---

            // Mostrar animaciÃ³n de "procesando" y deshabilitar botÃ³n
            procesando.style.display = "flex";
            boton.disabled = true;
            boton.style.backgroundColor = "#999";
            boton.textContent = "Procesando...";

            let exito = false;
            let tipo = null;

            try {
                const res = await fetch("{{ url_for('registrar', fecha=fecha) }}", { method: "POST" });
                if (res.ok) {
                    const data = await res.json();
                    exito = true;
                    tipo = data.tipo;
                }
            } catch(e) {
                console.error("Error al registrar:", e);
                exito = false;
            }
            
            setTimeout(() => {
                procesando.style.display = "none";

                if (exito) {
                    boton.style.backgroundColor = "#4CAF50";
                    boton.textContent = "âœ… Registrado";
                    reproducirSonido(true);
                    if (tipo === "entrada") {
                        mostrarMensajeFinal("Recuerda marcar la salida cuando finalices tu jornada ğŸ‘‹");
                    } else {
                        mostrarMensajeFinal("Hasta maÃ±ana, descansa ğŸ‘‹");
                    }
                } else {
                    boton.style.backgroundColor = "#f44336";
                    boton.textContent = "âŒ Error";
                    reproducirSonido(false);
                }

                setTimeout(() => {
                    boton.disabled = false;
                    boton.style.backgroundColor = "#5468ff";
                    boton.textContent = "Registrar";

                    // --- LÃ“GICA PARA DESCONGELAR LA IMAGEN ---
                    // 4. Ocultar la foto (canvas) y volver a mostrar el video en vivo
                    canvas.style.display = "none";
                    video.style.display = "block";
                    // --- FIN DE LA LÃ“GICA ---
                }, 1500);
            }, 1000);
        }
        
        // -------- Guardar Registros del DÃ­a en Excel --------
        async function guardarRegistrosDeHoy() {
            try {
                const res = await fetch("{{ url_for('guardar_registros_dia') }}", { method: "POST" });
                const data = await res.json();

                if (res.ok && data.status === "ok") {
                    mostrarMensajeFinal("âœ… " + data.msg);
                } else {
                    mostrarMensajeFinal("âŒ " + (data.msg || "Error desconocido al guardar."));
                }
            } catch (e) {
                console.error("Error en la solicitud para guardar:", e);
                mostrarMensajeFinal("âŒ Error de conexiÃ³n al intentar guardar el registro.");
            }
        }

        function reproducirSonido(exito) {
            const sonido = new Audio(exito
                ? "https://cdn.pixabay.com/audio/2022/03/15/audio_b5d1478e7d.mp3"
                : "https://cdn.pixabay.com/audio/2022/03/15/audio_5e88c904c4.mp3");
            sonido.play();
        }

        function mostrarMensajeFinal(mensaje) {
            const overlayExistente = document.querySelector(".overlay");
            if (overlayExistente) {
                overlayExistente.remove();
            }

            const overlay = document.createElement("div");
            overlay.classList.add("overlay");

            const mensajeDiv = document.createElement("div");
            mensajeDiv.classList.add("mensaje-final");
            mensajeDiv.innerHTML = mensaje;

            overlay.appendChild(mensajeDiv);
            document.body.appendChild(overlay);

            setTimeout(() => {
                overlay.classList.add("oculto");
                setTimeout(() => overlay.remove(), 600);
            }, 3000);
        }
    </script>
</body>

</html>