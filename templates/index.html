<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Registro de Entrada y Salida | GCO Grupo Uribe</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="{{ url_for('index') }}">Registro de Asistencia</a>
        <a href="{{ url_for('registros') }}">Registros de Empleados</a>
        <a href="{{ url_for('logout') }}" class="logout">Cerrar SesiÃ³n</a>
    </nav>

    <div class="main-flex">
        <div class="container">
            <h1 class="titulo-gco">GCO</h1>
            <h2>ğŸ“‹ Registro de Entrada y Salida</h2>
            <p>Fecha seleccionada: {{ fecha }}</p>

            <div class="video-container">
                <img id="camara" src="{{ url_for('video_feed') }}" width="640" height="400">
            </div>

            <button type="button" onclick="mostrarProcesando()">Registrar</button>

            <div id="procesando" class="mensaje-procesando">Guardando registro, por favor espere...</div>
        </div>
        <div class="guardar-lateral">
            <button onclick="guardarRegistro()">ğŸ’¾ Guardar registro de hoy</button>
        </div>
    </div>

    <script>
        // Forzar ocultar el mensaje de procesando al cargar la pÃ¡gina
        window.addEventListener('DOMContentLoaded', function() {
            var procesando = document.getElementById('procesando');
            if (procesando) procesando.style.display = 'none';
        });

        // -------- Registrar entrada/salida --------
        async function mostrarProcesando() {
            const video = document.getElementById("camara");
            const procesando = document.getElementById("procesando");
            const boton = document.querySelector("button");

            // Captura congelada
            const canvas = document.createElement("canvas");
            canvas.width = video.width;
            canvas.height = video.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imagenCongelada = canvas.toDataURL("image/jpeg");
            const original = video.src;
            video.src = imagenCongelada;

            procesando.style.display = "block";
            boton.disabled = true;
            boton.style.backgroundColor = "#999";
            boton.textContent = "Procesando...";

            let exito = false;
            let tipo = null;

            try {
                const res = await fetch("{{ url_for('registrar') }}", { method: "POST" });
                if (res.ok) {
                    const data = await res.json();
                    exito = true;
                    tipo = data.tipo;
                }
            } catch {
                exito = false;
            }

            setTimeout(() => video.src = original, 1000);

            setTimeout(() => {
                procesando.style.display = "none";

                if (exito) {
                    boton.style.backgroundColor = "#4CAF50";
                    boton.textContent = "âœ… Registrado";
                    reproducirSonido(true);

                    if (tipo === "entrada") {
                        mostrarMensajeFinal("Recuerda marcar la salida cuando finalices tu jornada ğŸ‘‹");
                    } else {
                        mostrarMensajeFinal("Hasta maÃ±ana, descansa ğŸ‘‹");
                    }
                } else {
                    boton.style.backgroundColor = "#f44336";
                    boton.textContent = "âŒ Error";
                    reproducirSonido(false);
                }

                setTimeout(() => {
                    boton.disabled = false;
                    boton.style.backgroundColor = "#5468ff";
                    boton.textContent = "Registrar";
                }, 1500);
            }, 2200);
        }

        function reproducirSonido(exito) {
            const sonido = new Audio(exito
                ? "https://cdn.pixabay.com/audio/2022/03/15/audio_b5d1478e7d.mp3"
                : "https://cdn.pixabay.com/audio/2022/03/15/audio_5e88c904c4.mp3");
            sonido.play();
        }

        function mostrarMensajeFinal(mensaje) {
            const overlay = document.createElement("div");
            overlay.classList.add("overlay");

            const mensajeDiv = document.createElement("div");
            mensajeDiv.classList.add("mensaje-final");
            mensajeDiv.innerHTML = mensaje;

            overlay.appendChild(mensajeDiv);
            document.body.appendChild(overlay);

            setTimeout(() => {
                overlay.classList.add("oculto");
                setTimeout(() => overlay.remove(), 600);
            }, 3000);
        }

        // -------- Guardar Excel --------
        async function guardarExcel() {
            try {
                const res = await fetch("{{ url_for('guardar_excel') }}", { method: "POST" });
                if (res.ok) {
                    const data = await res.json();
                    if (data.status === "ok") {
                        mostrarMensajeFinal("ğŸ’¾ Archivo guardado: " + data.archivo);
                    } else {
                        mostrarMensajeFinal("âŒ " + data.msg);
                    }
                } else {
                    mostrarMensajeFinal("âŒ Error al guardar Excel");
                }
            } catch {
                mostrarMensajeFinal("âŒ Error al guardar Excel");
            }
        }
    </script>
</body>

</html>